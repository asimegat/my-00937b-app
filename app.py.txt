import streamlit as st
import pandas as pd
import requests
from datetime import datetime
import plotly.graph_objects as go

st.set_page_config(page_title="00937B æŠ•è³‡è¿½è¹¤å™¨", layout="wide")

# 1. å¼·åŒ–ç‰ˆè³‡æ–™æŠ“å–å‡½æ•¸ï¼šä½¿ç”¨ç¶²é çˆ¬èŸ²ç¹é API é™åˆ¶
def get_stable_data():
    try:
        # ä½¿ç”¨ Google Finance æŠ“å–å³æ™‚å¸‚åƒ¹
        ticker = "00937B:TPE"
        url = f"https://www.google.com/finance/quote/{ticker}"
        response = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'})
        
        # ç°¡å–®çˆ¬èŸ²æŠ“å–åƒ¹æ ¼ (å°‹æ‰¾ class åŒ…å«YMlKec fxKbKc çš„å…ƒç´ )
        from bs4 import BeautifulSoup
        soup = BeautifulSoup(response.text, 'html.parser')
        price_text = soup.find(class_='YMlKec fxKbKc').text
        current_price = float(price_text.replace('$', '').replace(',', ''))

        # 2. æ­£ç¢ºçš„ 00937B é…æ¯æ•¸æ“šæ¸…å–® (æˆªè‡³ 2025/12)
        # è€ƒæ…®åˆ° API ä¸ç©©å®šï¼Œç›´æ¥å°‡æ­£ç¢ºæ­·å²æ•¸æ“šå¯«å…¥ç¨‹å¼ç¢¼æœ€ä¿éšª
        div_data = {
            'Date': [
                '2024-02-27', '2024-03-18', '2024-04-18', '2024-05-17', '2024-06-18', '2024-07-16',
                '2024-08-16', '2024-09-18', '2024-10-18', '2024-11-18', '2024-12-16',
                '2025-01-16', '2025-02-18', '2025-03-18', '2025-04-16', '2025-05-16', '2025-06-16',
                '2025-07-16', '2025-08-18', '2025-09-16', '2025-10-16', '2025-11-18', '2025-12-16'
            ],
            'Amount': [
                0.084, 0.084, 0.084, 0.084, 0.084, 0.084,
                0.082, 0.082, 0.082, 0.082, 0.082,
                0.082, 0.082, 0.080, 0.080, 0.077, 0.077,
                0.072, 0.072, 0.072, 0.072, 0.072, 0.072
            ]
        }
        df_divs = pd.DataFrame(div_data)
        df_divs['Date'] = pd.to_datetime(df_divs['Date'])
        
        return current_price, df_divs
    except Exception as e:
        st.error(f"æ•¸æ“šåŠ è¼‰å¤±æ•—: {e}")
        return None, None

# ä»‹é¢è¨­è¨ˆ
st.title("ğŸ›¡ï¸ 00937B æŠ•è³‡æˆæœ¬ç›£æ§ (ç©©å®šç‰ˆ)")

with st.sidebar:
    st.header("æŠ•è³‡åƒæ•¸")
    buy_price = st.number_input("è²·é€²å–®åƒ¹", value=15.54)
    shares = st.number_input("æŒæœ‰å¼µæ•¸", value=10)
    buy_date = st.date_input("è²·é€²æ—¥æœŸ", value=datetime(2023, 12, 1))

# å–å¾—æ•¸æ“š
current_price, df_divs = get_stable_data()

if current_price:
    # éæ¿¾é ˜æ¯æ—¥
    my_divs = df_divs[df_divs['Date'] >= pd.to_datetime(buy_date)]
    total_div = my_divs['Amount'].sum()
    
    # è¨ˆç®—
    total_shares = shares * 1000
    capital_in = buy_price * total_shares
    dividend_received = total_div * total_shares
    real_cost = buy_price - total_div
    market_value = current_price * total_shares
    total_gain = (market_value - capital_in) + dividend_received
    
    # æŒ‡æ¨™é¡¯ç¤º
    c1, c2, c3 = st.columns(3)
    c1.metric("å¯¦è³ªæˆæœ¬ (æ¯è‚¡)", f"{real_cost:.3f}")
    c2.metric("ç´¯ç©é ˜æ¯", f"${dividend_received:,.0f}")
    c3.metric("ç¸½å ±é…¬ç‡", f"{(total_gain/capital_in)*100:.2f}%")

    # åœ“é¤…åœ–
    fig = go.Figure(data=[go.Pie(labels=['åŸå§‹æŠ•å…¥', 'ç´¯ç©æ¯æ”¶', 'åƒ¹å·®æç›Š'], 
                                 values=[capital_in-dividend_received, dividend_received, max(0, market_value-capital_in)],
                                 hole=.4)])
    st.plotly_chart(fig)
    
    st.info(f"å³æ™‚å¸‚åƒ¹: {current_price} | ç´¯è¨ˆé…æ¯æ¬¡æ•¸: {len(my_divs)} æ¬¡")